name: Build APK and notify

on:
  push:
    paths:
      - '**.kt'
      - '**.xml'
      - '**.java'
      - '**.gradle'
      - 'trigger.txt'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: 17

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Build debug APK and handle errors
      run: |
        ./gradlew assembleDebug > build.log 2>&1 || {
          echo "❌ Error during build"
          tail -n 200 build.log | grep -A 10 -B 10 -iE 'error|exception|failed' > error.txt || tail -n 100 build.log > error.txt
          curl -F document=@error.txt -F chat_id=${{ secrets.TELEGRAM_TO }} -F caption="❌ Build failed" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument"
          exit 1
        }

    - name: Send APK to Telegram
      if: success()
      run: |
        curl -F document=@app/build/outputs/apk/debug/app-debug.apk -F chat_id=${{ secrets.TELEGRAM_TO }} -F caption="✅ APK built successfully" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument"
