name: Android CI

on:
  push:
    paths:
      - '**.kt'
      - '**.xml'
      - '**.java'
      - '**.gradle'
      - 'trigger.txt'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: 17

    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew

    - name: Build Debug APK
      id: build_apk
      run: |
        ./gradlew assembleDebug > build.log 2>&1 || {
          echo "❌ Build failed, sending error to Telegram..."
          tail -n 100 build.log | grep -A 10 -B 10 -iE 'error|exception|failed' > error.log || tail -n 100 build.log > error.log
          curl -F document=@error.log -F chat_id=${{ secrets.TELEGRAM_TO }} -F caption="❌ Build failed — see error.log" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument"
          exit 1
        }

    - name: Send APK to Telegram
      if: success()
      run: |
        curl -F document=@app/build/outputs/apk/debug/app-debug.apk -F chat_id=${{ secrets.TELEGRAM_TO }} -F caption="✅ Build successful — APK attached" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument"
