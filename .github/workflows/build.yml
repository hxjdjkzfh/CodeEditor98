name: Android CI Build

on:
  push:
    branches: ["master"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: Make Gradle executable
        run: chmod +x ./gradlew

      - name: Build and notify Telegram
        run: |
          # Собираем и сохраняем лог в память
          set +e
          ./gradlew clean assembleDebug > build.log 2>&1
          set -e

          APK="app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK" ]; then
            # Успешно собралось — отправляем APK
            curl -s -F chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -F document=@"$APK" \
              -F caption="✅ Сборка успешна! APK готов." \
              "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument"
          else
            # Сборка упала — отправляем первую строку ошибки
            ERR=$(grep -m1 -E "^e:|error:" build.log)
            [ -z "$ERR" ] && ERR="Неизвестная ошибка. Смотрите build.log."
            ESC_ERR=$(echo "$ERR" | sed 's/`/\\`/g')
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d parse_mode="Markdown" \
              --data-urlencode "text=❌ *Сборка не удалась!*\n\`\`\`\n\$ESC_ERR\n\`\`\`"
          fi
